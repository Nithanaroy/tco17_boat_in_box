<meta name="robots" content="noindex">
<html>

<head>
    <meta charset="utf-8">
    <title>Boat in a box</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
        crossorigin="anonymous" />
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN"
        crossorigin="anonymous" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
        }
        
        html,
        body,
        #wrapper,
        .full-screen-page {
            height: 100%;
        }
        
        #wrapper {}
        
        #alert-container {
            position: absolute;
            top: 1rem;
            text-align: center;
            width: 100%;
            /* highest of all */
            z-index: 405;
        }
        
        #alert-container .alert {
            display: inline-block;
            margin-bottom: 0;
        }
        
        button {
            background: #595A53;
            color: #C8C8C7;
            border: none;
        }
        
        .container-fluid {
            padding-left: 0;
            padding-right: 0;
        }
        
        bb-home-page {
            display: flex;
            flex-direction: column;
        }
        
        #top-header {
            background: #373833;
            padding: 1rem 4rem;
        }
        
        #left-nav {
            position: absolute;
            top: 7rem;
            left: 4rem;
            z-index: 402;
            /* 2 more than leaflet map */
        }
        
        #left-nav ul {
            padding: 0;
            box-shadow: 0 0 10px #000;
        }
        
        #left-nav li {
            list-style: none;
            background: #202123;
            width: 5rem;
            height: 5rem;
            color: #E1D1A6;
            text-align: center;
            line-height: 5rem;
            border-bottom: 1px solid #2F3437;
        }
        
        #left-nav li:last-child {
            border-bottom: none;
        }
        
        #left-nav li:hover {
            background: #17181A;
            cursor: pointer;
        }
        
        #left-nav li.selected {
            background: #17181A;
        }
        
        #ship-count {
            position: absolute;
            bottom: 10rem;
            left: 4rem;
            background: #202123;
            padding: 1rem 0.5rem;
            box-shadow: 0 0 10px #000;
            border-radius: 2px;
            z-index: 402;
            /* 2 more than leaflet map */
        }
        
        #ship-count h2 {
            color: #FFF;
            margin-bottom: 0;
            margin-top: 0;
        }
        
        #map-container {
            background: #131313;
            flex-grow: 1;
        }
        
        #timeline table {
            width: 100%;
        }
        
        #timeline table tr:first-child {
            text-align: center;
            background: #202123;
            font-size: 0.5rem;
            color: #475256;
            border-top: 1px solid #2F3436;
            border-bottom: 1px solid #2F3436;
        }
        
        #timeline table tr:first-child td {
            padding: 0.75rem;
        }
        
        #timeline table tr:last-child {
            background: #17181A;
        }
        
        #timeline table tr:last-child td {
            height: 5rem;
        }
        
        #timeline table tr:last-child td div {
            border-right: 1px solid #1D1E20;
            height: 100%;
            padding: 0;
        }
        
        .leaflet-tile {
            border: solid #353737 1px;
        }
        
        .leaflet-tile td {
            border-right: solid #353737 1px;
            border-bottom: solid #353737 1px;
        }
        
        #shipVisualCue {
            position: absolute;
            font-size: 2rem;
            border: dashed 1px #FFF;
            background-color: rgba(20, 40, 29, 0.5);
            padding: 1rem;
            color: #E1D1A6;
            display: none;
            /* highest of all */
            z-index: 405;
            cursor: pointer;
            pointer-events: none;
        }
        
        #ship-info {
            position: absolute;
            width: 35rem;
            /* highest of all */
            z-index: 405;
            color: #C8C8C8;
            font-size: 10px;
        }
        
        #ship-info .col-sm-6,
        #ship-info .col-sm-11 {
            padding: 0;
        }
        
        #ship-info .panel-heading {
            border-bottom: 1px solid #2F3437;
        }
        
        #ship-info .panel,
        #ship-info .panel-footer {
            background: #202123;
        }
        
        #ship-info .panel-title {
            font-size: 2rem;
            margin: 1rem 0;
            font-weight: normal;
        }
        
        #ship-info label {
            font-weight: normal;
        }
        
        #ship-info .form-control {
            background: #2C2D30;
            color: #6F7072;
            border: none;
            font-size: 1rem;
            height: 2.5rem;
        }
        
        #ship-info .panel-footer {
            border-top: 1px solid #2F3437;
            margin-bottom: 1rem;
        }
        
        #ship-info .panel-footer button {
            background: #527E43;
            font-size: 1rem;
        }
        
        #ship-info .close span {
            color: #485357;
        }
    </style>
</head>

<body>
    <div id="wrapper" class="container-fluid"></div>
    <script id="app-template" type="text/stache">
        <bb-home-page class="full-screen-page"></bb-home-page>
    </script>
    <script id="alert-template" type="text/stache">
        {{#if showAlert}}
        <div id="alert-container">
            <div class="alert alert-info" role="alert">
                <!--<button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>-->
                <p>{{alertMsg}}</p>
            </div>
        </div>
        {{/if}}
    </script>
    <script id="home-template" type="text/stache">
        <bb-alert {alert-msg}="alertMsg"></bb-alert>
        <!-- Ideally should be in app template level -->
        <header id="top-header">
            <button class="btn-sm" style="margin-right: 1rem;">OPEN</button>
            <button class="btn-sm">SAVE</button>
        </header>
        <div id="left-nav">
            <ul>
                <li title="Add Ship" ($click)="addShip()" class="{{#eq leftNavSelectedIndex 1}}selected{{/eq}}">
                    <i class="fa fa-ship" aria-hidden="true"></i>
                </li>
                <li title="Add AIS" class="{{#eq leftNavSelectedIndex 2}}selected{{/eq}}">
                    <i class="fa fa-envelope" aria-hidden="true"></i>
                </li>
                <li title="Remove this tool" class="{{#eq leftNavSelectedIndex 3}}selected{{/eq}}">
                    <i class="fa fa-minus-square" aria-hidden="true"></i>
                </li>
            </ul>
        </div>
        <div id="ship-count">
            <table>
                <tr>
                    <td rowspan="2" style="color: #E1D1A6; font-size: 2rem;">
                        <i class="fa fa-ship" aria-hidden="true" style="margin-right: 1rem;">
                        </td>
                    <td><h2>721</h2></td>
                </tr>
                <tr>
                    <td style="color: #383F42; font-size: 0.5rem;">Ships Total</td>
                </tr>
            </table>
        </div>

        <div id="map-container"></div>
        <div id="timeline">
            <table>
                <tr>
                    <td style="max-width: 165px; text-align: left; color: #AEAEAF; font-size: 1.3rem;">TIMELINE VIEW</td>
                    {{#times}}
                    <td>{{.}}</td>
                    {{/times}}
                </tr>
                <tr>
                    <td></td>
                    {{#times}}
                    <td>
                        <div class="col-sm-6"></div>
                    </td>
                    {{/times}}
                </tr>
            </table>
        </div>
        
        <div id="shipVisualCue" {{#if shipCueEnabled}}style="display: block;"{{/if}}>
            <i class="fa fa-ship" aria-hidden="true"></i>
        </div>
        <div id="ship-info" style="top: {{shipInfoPos.top}}px; left: {{shipInfoPos.left}}px;">
            <div class="panel">
                <div class="panel-heading">
                    <button type="button" class="close" aria-label="Close" ($click)="hideShipInfo()"><span aria-hidden="true">&times;</span></button>
                    <h3 class="panel-title">SHIP INFORMATION</h3>
                </div>
                <div class="panel-body">
                    <p>
                        <span id="ship-lat">27.6747</span>;<span id="ship-lng">89.7464</span>
                    </p>
                    <div class="form-group">
                        <label for="ship-name">SHIP NAME</label>
                        <input type="text" class="form-control" id="ship-name" placeholder="Enter ship name here">
                    </div>
                    <div class="form-group col-sm-6">
                        <div class="col-sm-11">
                            <label for="ship-course">COURSE</label>
                            <div style="display: flex;">
                                <input type="text" class="form-control" id="ship-course" placeholder="Ship course" style="flex: 1;">
                                <span style="margin-left: 0.5rem; line-height: 2.5rem; vertical-align: middle;"> <sup>o</sup>Degree</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group col-sm-6">
                        <div class="col-sm-11">
                            <label for="ship-speed">SPEED</label>
                            <div style="display: flex;">
                                <input type="text" class="form-control" id="ship-speed" placeholder="Ship speed" style="flex: 1;">
                                <span style="margin-left: 0.5rem; line-height: 2.5rem; vertical-align: middle;"> Knots</span>
                            </div>
                        </div>
                    </div>
                    <div class="clearfix"></div>
                </div>
                <div class="panel-footer">
                    <button class="btn-sm btn-success" ($click)="saveShip()">SAVE</button>
                    <button class="btn-sm btn-success" ($click)="addWayPoint()">WAYPOINT</button>
                    <button class="btn-sm btn-success">AIS MESSAGE</button>
                </div>
            </div>
        </div>
    </script>
    <script src="https://unpkg.com/can/dist/global/can.all.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
        crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous"></script>
            <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
            <script>
                let mymap = null; // global reference to leaflet map

                /* Fixtures */
                let shipsStore = can.fixture.store([]);
                can.fixture("/api/ship", shipsStore);
                can.fixture.delay = 1000;

                /* Models */
                let WayPointModel = can.DefineMap.extend({
                    lat: "number",
                    lng: "number"
                });
                let ShipModel = can.DefineMap.extend({
                    id: "number",
                    name: "string",
                    course: "string",
                    speed: "number",
                    waypoints: can.DefineList.extend({
                        "Map": WayPointModel
                    })
                });
                ShipModel.List = can.DefineList.extend({
                    "Map": ShipModel
                });
                can.connect.baseMap({
                    "idProp": "id",
                    "Map": ShipModel,
                    "List": ShipModel.List,
                    "url": "/api/ship/",
                    "name": "Ship",
                    "parseListProp": "result"
                });

                /* Components */
                let AppViewModel = can.DefineMap.extend({
                    alertMsg: {
                        "type": "string",
                        "value": "Init"
                    }
                });
                let HomeViewModel = can.DefineMap.extend({
                    mapRef: "*",
                    componentInserted: function () {
                        this.initializeMap();
                        this.subscribeToMapEvents();
                    },
                    initializeMap: function () {
                        var map = L.map('map-container', {
                            zoomControl: false
                        }).setView([17.937107, -76.221486], 6);
                        L.tileLayer(
                            'https://api.mapbox.com/styles/v1/mapbox/dark-v9/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1Ijoibml0aGFuYXJveSIsImEiOiJVTlQ0bUtJIn0.xHgUVf3z6KU1IociPuP-5g', {
                                attribution: '',
                                maxZoom: 18,

                            }).addTo(map);
                        this.mapRef = map;
                        mymap = map;
                    },
                    subscribeToMapEvents: function () {
                        const self = this;
                        mymap.on("click", function (event) {
                            self.onMapClick.call(self, event);
                        });
                    },
                    handleAddingShip: function (event) {
                        this.leftNavSelectedIndex = 0;
                        this.shipCueEnabled = false;
                        L.marker(event.latlng).addTo(mymap);
                        this.shipInfoPos.left = event.originalEvent.clientX;
                        this.shipInfoPos.top = event.originalEvent.clientY;
                    },
                    handleAddingEndpoint: function (event) {
                        const self = this;
                        L.marker(event.latlng).on("click", function () {
                            self.endPointClicked.call(self, event);
                        }).addTo(mymap);
                        this.ship.waypoints.push(new WayPointModel({
                            lat: event.latlng.lat,
                            lng: event.latlng.lng
                        }));
                        this.action = "waypoint";
                        console.log("end point added");
                    },
                    handleAddingWaypoint: function (event) {
                        L.marker(event.latlng).addTo(mymap);
                        // Add this as the last but one point. The end point is added already
                        this.ship.waypoints.splice(this.ship.waypoints.length - 1, 1, new WayPointModel({
                            lat: event.latlng.lat,
                            lng: event.latlng.lng
                        }));
                        console.log("way point added");
                    },
                    endPointClicked: function (event) {
                        this.action = ""; // complete adding way points
                        this.ship.save().catch(handleErrors);
                    },
                    onMapClick: function (event) {
                        if (this.leftNavSelectedIndex === 1) {
                            this.handleAddingShip(event);
                        } else if (this.action === "waypoint") {
                            this.handleAddingWaypoint(event);
                        } else if (this.action === "endpoint") {
                            this.handleAddingEndpoint(event);
                        }
                    },
                    times: {
                        value: function () {
                            times = [];
                            for (let i = 0; i < 10; i++) {
                                times.push(`0${i}:00`);
                            }
                            for (let i = 10; i < 25; i++) {
                                times.push(`${i}:00`);
                            }
                            return times;
                        }
                    },
                    leftNavSelectedIndex: {
                        value: 0
                    },
                    shipCueEnabled: {
                        value: false
                    },
                    shipInfoPos: {
                        value: {
                            top: -999,
                            left: -999
                        }
                    },
                    action: {
                        value: ""
                    }, // endpoint, waypoint
                    ship: {
                        Type: ShipModel,
                        Value: ShipModel
                    },
                    alertMsg: {
                        "type": "string",
                        "value": null
                    },
                    hideShipInfo: function () {
                        this.shipInfoPos = {
                            top: -999,
                            left: -999
                        };
                    },
                    addShip: function addShip() {
                        this.leftNavSelectedIndex = 1;
                        this.shipCueEnabled = true;
                    },
                    addWayPoint: function () {
                        this.action = "endpoint";
                    },
                    saveShip: function () {
                        const self = this;
                        this.ship.save().then(function () {
                            self.alertMsg = "Saved ship successfully";
                        }).catch(handleErrors);
                    }
                });

                can.Component.extend({
                    tag: "bb-alert",
                    view: can.stache.from("alert-template"),
                    viewModel: {
                        alertMsg: {
                            "type": "string",
                            "value": null
                        },
                        showAlert: {
                            value: function () {
                                return this.alertMsg && this.alertMsg.length > 0;
                            }
                        }
                    },
                    "events": {
                        "{viewModel} alertMsg": function () {
                            const self = this;
                            self.viewModel.showAlert = true;
                            window.setTimeout(function () {
                                self.viewModel.showAlert = false;
                            }, 2000);
                        }
                    }
                });

                can.Component.extend({
                    "tag": "bb-home-page",
                    "view": can.stache.from('home-template'),
                    "viewModel": HomeViewModel,
                    "events": {
                        inserted: function componentInserted() {
                            this.viewModel.componentInserted();
                        },
                        "{viewModel} shipCueEnabled": function (viewModel, event, shipCueVisible, oldVal) {
                            if (shipCueVisible) {
                                $("#map-container").mousemove(function (event) {
                                    shipVisualCue.css({
                                        "left": event.clientX,
                                        "top": event.clientY
                                    });
                                });
                            } else {
                                $("#map-container").unbind("mousemove");
                            }
                        }
                    }
                });

                function disableMap() {
                    mymap.dragging.disable();
                    mymap.touchZoom.disable();
                    mymap.doubleClickZoom.disable();
                    mymap.scrollWheelZoom.disable();
                    mymap.boxZoom.disable();
                    mymap.keyboard.disable();
                }

                function enableMap() {
                    mymap.dragging.enable();
                    mymap.touchZoom.enable();
                    mymap.doubleClickZoom.enable();
                    mymap.scrollWheelZoom.enable();
                    mymap.boxZoom.enable();
                    mymap.keyboard.enable();
                }

                function handleErrors() {

                }

                var template = can.stache.from("app-template");
                var frag = template(new AppViewModel());
                document.getElementById("wrapper").appendChild(frag);

                const shipVisualCue = $("#shipVisualCue");

                console.log(
                    'Map attribution: Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>'
                )
            </script>
</body>

</html>